<!DOCTYPE html>
<html>

<head>
    <title>Firebase a Leaflet Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }


        #map {
            width: 100vw;
            height: 100vh;
        }

        .delete-button {
            background-color: #ff3b30;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>


<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>


    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>


    <!-- Add the Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>


    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGtxgHtTMqkSiokZjrQLPGvKBMqgCfgZQ",
            authDomain: "pgpbl-react.firebaseapp.com",
            databaseURL: "https://pgpbl-react-default-rtdb.firebaseio.com",
            projectId: "pgpbl-react",
            storageBucket: "pgpbl-react.firebasestorage.app",
            messagingSenderId: "427947327183",
            appId: "1:427947327183:web:beb8c6b2313c1b6b4241ba",
            measurementId: "G-WWGFMZGXP1",
        };


        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();


        // Initialize the map
        const map = L.map('map').setView([-7.7956, 110.3695], 13);


        // Add a tile layer (the map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Create a layer group to hold markers, so we can clear them easily.
        const markerGroup = L.layerGroup().addTo(map);

        // Get a reference to the database service
        const pointsRef = database.ref("/points");


        // Attach an asynchronous callback to read the data at our posts reference
        pointsRef.on('value', (e) => {
            const data = e.val();
            // Clear existing markers to avoid duplicates
            markerGroup.clearLayers();

            if (data) {
                Object.keys(data).forEach((key) => {
                    const point = data[key];
                    if (point.coordinates && typeof point.coordinates === 'string') {
                        const coords = point.coordinates.split(",").map(parseFloat);
                        
                        // Ensure coordinates are valid numbers
                        if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                            const marker = L.marker(coords);
                            
                            // Create popup content with a delete button
                            const popupContent = `
                                <b>${point.name || 'No Name'}</b><brr>
                                ${point.coordinates}<br>
                                <button class="delete-button" onclick="deletePoint('${key}')">
                                    <i class="fa-solid fa-trash"></i> Hapus
                                </button>
                            `;

                            marker.bindPopup(popupContent);
                            
                            // Add marker to the group
                            markerGroup.addLayer(marker);
                        }
                    }
                });
            }
        }, (errorObject) => {
            console.log("The read failed: " + errorObject.name);
        });

        // Delete point function
        function deletePoint(key) {
            if (confirm("Yakin akan menghapus point ini?")) {
                pointsRef.child(key).remove();
                // The 'value' listener will automatically update the map, no page reload needed.
            }
        }
    </script>
</body>

</html>